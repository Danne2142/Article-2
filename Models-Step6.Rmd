---
title: "Model 1"
output: html_document
date: "2024-11-01"
---
```{r}
# #Set working directory
# setwd("C:/Users/danwik/OneDrive - Karolinska Institutet/Documents/Project 2 - Vscode/Program")

#import functions
source("C:/Users/danwik/OneDrive - Karolinska Institutet/Documents/Project 2 - Vscode/Program/modelingFunctions.R")
source("C:/Users/danwik/OneDrive - Karolinska Institutet/Documents/Project 2 - Vscode/Program/plot_forest().R")


```

```{r}
library(mice)
load("C:/Users/danwik/OneDrive - Karolinska Institutet/Documents/Project 2 - Vscode/Output/imputed_survey1")
#rename object
imp_data_surv1 <- imputed_data
df1_imp_data_surv1<-complete(imputed_data, 1)

# load("C:/Users/danwik/OneDrive - Karolinska Institutet/Documents/Project 2 - Vscode/Output/imputed_survey2.RData")
# #rename object
# imp_data_surv2 <- imputed_data
# df1_imp_data_surv1<-complete(imputed_data, 1)

# load("C:/Users/danwik/OneDrive - Karolinska Institutet/Documents/Project 2 - Vscode/Output/imputed_survey3.RData")
# #rename object
# imp_data_surv3 <- imputed_data
# df1_imp_data_surv1<-complete(imputed_data, 1)
```

### Model 1 - Survey1
```{r}
interventions<-c("Rapamycin_new", "Metformin_new", "fasting", "NAD", "TA65", 
"sulforaphane", "DHEA_new", "SASP_supressors", "Resveratrol_new", "Exosomes", 
"HRT", "spermidine", "semaglutide", "vitaminD", "AKG")

lifestyle_covariates_survey1<-c("Alcohol_per_week_numeric",  
"Education_levels_numeric", "Stress.Level", "Tobacco.Use.Numeric", 
"Exercise.per.week_numeric", "Exercise.Type",  
"Hours.of.sleep.per.night", "Main.Diet.Factor" , "BMI", "Caffeine.Use_numeric", "Marital.Status_numeric", "Sexual.Frequency_numeric")

covariates_to_always_include<-c("Decimal.Chronological.Age", "Biological.Sex" )


combined_results_df<-model_exposure_wise(path="C:/Users/danwik/OneDrive - Karolinska Institutet/Documents/Project 2 - Vscode/Output/imputed_survey1", outcome_vars=c("DunedinPACE", "GrimAge.PCAgeDev", "OMICmAgeAgeDev"), exposure_vars=c(interventions,lifestyle_covariates_survey1), covariate_vars = covariates_to_always_include)

library(ggplot2)

# Save DunedinPACE plot
p1 <- plot_forest(combined_results_df[["DunedinPACE"]])
ggsave("C:/Users/danwik/OneDrive - Karolinska Institutet/Documents/Project 2 - Vscode/Output/DunedinPACE_Model1_Survey1_plot.png", plot = p1)

# Save GrimAge.PCAgeDev plot
p2 <- plot_forest(combined_results_df[["GrimAge.PCAgeDev"]])
ggsave("C:/Users/danwik/OneDrive - Karolinska Institutet/Documents/Project 2 - Vscode/Output/GrimAge_PCAgeDev_Model1_Survey1_plot.png", plot = p2)

# Save OMICmAgeAgeDev plot
p3 <- plot_forest(combined_results_df[["OMICmAgeAgeDev"]])
ggsave("C:/Users/danwik/OneDrive - Karolinska Institutet/Documents/Project 2 - Vscode/Output/OMICmAgeAgeDev_Model1_Survey1_plot.png", plot = p3)

# Save as dataframes
DunedinPACE_Model1_Survey1<-combined_results_df[["DunedinPACE"]]
GrimAge_PCAgeDev_Model2_Survey1<-combined_results_df[["GrimAge.PCAgeDev"]]
OMICmAgeAgeDev_Model1_Survey1<-combined_results_df[["OMICmAgeAgeDev"]]

#' Remove terms from models if p-value > 0.15 across all models
#' 
#' @description
#' Evaluates terms across multiple models and removes those with p-value > 0.15 in all models.
#' Categorical variables can be excluded from this evaluation.
#' 
#' @param terms Vector of term names to evaluate
#' @param dfs List of dataframes containing model results with columns 'term' and 'p.value'
#' @param categorical_variables_to_exclude Optional vector of categorical variable names to retain
#' 
#' @return Vector of remaining terms after removal
#' 
remove_terms_if_p_large <- function(terms, dfs, categorical_variables_to_exclude = NULL) {
  # Initialize storage vectors
  remaining_terms <- c()
  removed_terms <- c()

  # Process each term
  for (term in terms) {
    print(term)

    # Handle categorical variables: retain regardless of p-value
    if (!is.null(categorical_variables_to_exclude) && term %in% categorical_variables_to_exclude) {
      remaining_terms <- c(remaining_terms, term)
      next
    }
    
    # Check if p-value exceeds threshold in all models
    all_over_15 <- all(sapply(dfs, function(df) {
      row_match <- df[df$term == term, ]
      row_match$p.value > 0.15
    }))
    
    # Track results: keep term if significant in any model
    if (!all_over_15) {
      remaining_terms <- c(remaining_terms, term)
    } else {
      removed_terms <- c(removed_terms, term)
    }
  }
  
  # Report results
  if (length(removed_terms) > 0) {
    cat("\nRemoved terms with p > 0.15 in all models:\n")
    cat(paste("-", removed_terms), sep = "\n")
  } else {
    cat("\nNo terms were removed\n")
  }
  
  return(remaining_terms)
}

lifestyle_covariates_survey1_updated <- remove_terms_if_p_large(
  lifestyle_covariates_survey1, categorical_variables_to_exclude=c("Main.Diet.Factor", "Exercise.Type"),
  list(DunedinPACE_Model1_Survey1, 
    GrimAge_PCAgeDev_Model2_Survey1, 
    OMICmAgeAgeDev_Model1_Survey1))


interventions_large_p <- remove_terms_if_p_large(
  interventions, 
  list(DunedinPACE_Model1_Survey1, 
    GrimAge_PCAgeDev_Model2_Survey1, 
    OMICmAgeAgeDev_Model1_Survey1))

```

### Model 2 -survey 1
```{r}
covariates_to_always_include<-c(c("Decimal.Chronological.Age", "Biological.Sex", lifestyle_covariates_survey1_updated ))

combined_results_df<-model_exposure_wise(path="C:/Users/danwik/OneDrive - Karolinska Institutet/Documents/Project 2 - Vscode/Output/imputed_survey1", outcome_vars=c("DunedinPACE", "GrimAge.PCAgeDev", "OMICmAgeAgeDev"), exposure_vars=interventions_large_p, covariate_vars = covariates_to_always_include)

# Save DunedinPACE plot
p4 <- plot_forest(combined_results_df[["DunedinPACE"]])
ggsave("C:/Users/danwik/OneDrive - Karolinska Institutet/Documents/Project 2 - Vscode/Output/DunedinPACE_Model2_Survey1_plot.png", plot = p4)

# Save GrimAge.PCAgeDev plot
p5 <- plot_forest(combined_results_df[["GrimAge.PCAgeDev"]])
ggsave("C:/Users/danwik/OneDrive - Karolinska Institutet/Documents/Project 2 - Vscode/Output/GrimAge_PCAgeDev_Model2_Survey1_plot.png", plot = p5)

# Save OMICmAgeAgeDev plot
p6 <- plot_forest(combined_results_df[["OMICmAgeAgeDev"]])
ggsave("C:/Users/danwik/OneDrive - Karolinska Institutet/Documents/Project 2 - Vscode/Output/OMICmAgeAgeDev_Model2_Survey1_plot.png", plot = p6)

# Save as dataframes
DunedinPACE_Model2_Survey1<-combined_results_df[["DunedinPACE"]]
GrimAge_PCAgeDev_Model2_Survey1<-combined_results_df[["GrimAge.PCAgeDev"]]
OMICmAgeAgeDev_Model2_Survey1<-combined_results_df[["OMICmAgeAgeDev"]]


```

### Model 3_HRT - Survey 1
```{r}
# Remove terms that are included in other terms (for example, if 'DHEA' is included, 'HRT') when running full models
exclusions <- c("DHEA"))
# Filter out the exclusions
filtered_interventions_large_p <- interventions_large_p[!interventions_large_p %in% exclusions]


model3_DunedinPACE<-fit_imputed_lm(imp_data_surv1, outcome = "DunedinPACE", exposures=filtered_interventions_large_p, covariates=covariates_to_always_include)

# Save DunedinPACE plot
p7 <- plot_forest(model3_DunedinPACE)
ggsave("C:/Users/danwik/OneDrive - Karolinska Institutet/Documents/Project 2 - Vscode/Output/DunedinPACE_Model3_HRT_Survey1_plot.png", plot = p7)
# Save as dataframes
DunedinPACE_Model3_HRT_Survey1<-combined_results_df[["DunedinPACE"]]


model3_GrimAge_PCAgeDev<-fit_imputed_lm(imp_data_surv1, outcome = "GrimAge.PCAgeDev", exposures=filtered_interventions_large_p, covariates=covariates_to_always_include)
# Save GrimAge.PCAgeDev plot
p8 <- plot_forest(model3_GrimAge_PCAgeDev)
ggsave("C:/Users/danwik/OneDrive - Karolinska Institutet/Documents/Project 2 - Vscode/Output/GrimAge_PCAgeDev_Model3_HRT_Survey1_plot.png", plot = p8)
# Save as dataframes
GrimAge_PCAgeDev_Model3_HRT_Survey1<-combined_results_df[["GrimAge.PCAgeDev"]]


model3_OMICmAgeAgeDev<-fit_imputed_lm(imp_data_surv1, outcome = "OMICmAgeAgeDev", exposures=filtered_interventions_large_p, covariates=covariates_to_always_include)
# Save OMICmAgeAgeDev plot
p9 <- plot_forest(model3_OMICmAgeAgeDev)
ggsave("C:/Users/danwik/OneDrive - Karolinska Institutet/Documents/Project 2 - Vscode/Output/OMICmAgeAgeDev_Model3_HRT_Survey1_plot.png", plot = p9)
# Save as dataframes
OMICmAgeAgeDev_Model3_HRT_Survey1<-combined_results_df[["OMICmAgeAgeDev"]]

```


### Model 3_DHEA - Survey 1
```{r}
# Remove terms that are included in other terms (for example, if 'DHEA' is included, 'HRT') when running full models
exclusions <- c("HRT"))
# Filter out the exclusions
filtered_interventions_large_p <- interventions_large_p[!interventions_large_p %in% exclusions]


model3_DunedinPACE<-fit_imputed_lm(imp_data_surv1, outcome = "DunedinPACE", exposures=filtered_interventions_large_p, covariates=covariates_to_always_include)

# Save DunedinPACE plot
p10 <- plot_forest(model3_DunedinPACE)
ggsave("C:/Users/danwik/OneDrive - Karolinska Institutet/Documents/Project 2 - Vscode/Output/DunedinPACE_Model3_DHEA_Survey1_plot.png", plot = p7)
# Save as dataframes
DunedinPACE_Model3_DHEA_Survey1<-combined_results_df[["DunedinPACE"]]


model3_GrimAge_PCAgeDev<-fit_imputed_lm(imp_data_surv1, outcome = "GrimAge.PCAgeDev", exposures=filtered_interventions_large_p, covariates=covariates_to_always_include)
# Save GrimAge.PCAgeDev plot
p11 <- plot_forest(model3_GrimAge_PCAgeDev)
ggsave("C:/Users/danwik/OneDrive - Karolinska Institutet/Documents/Project 2 - Vscode/Output/GrimAge_PCAgeDev_Model3_DHEA_Survey1_plot.png", plot = p8)
# Save as dataframes
GrimAge_PCAgeDev_Model3_DHEA_Survey1<-combined_results_df[["GrimAge.PCAgeDev"]]


model3_OMICmAgeAgeDev<-fit_imputed_lm(imp_data_surv1, outcome = "OMICmAgeAgeDev", exposures=filtered_interventions_large_p, covariates=covariates_to_always_include)
# Save OMICmAgeAgeDev plot
p12 <- plot_forest(model3_OMICmAgeAgeDev)
ggsave("C:/Users/danwik/OneDrive - Karolinska Institutet/Documents/Project 2 - Vscode/Output/OMICmAgeAgeDev_Model3_DHEA_Survey1_plot.png", plot = p9)
# Save as dataframes
OMICmAgeAgeDev_Model3_DHEA_Survey1<-combined_results_df[["OMICmAgeAgeDev"]]

```

### model 1 - Survey2
```{r}
# interventions<-c("Rapamycin_new", "Metformin_new", "fasting", "NAD", "TA65", "sulforaphane", "DHEA_new", "SASP_supressors", "Resveratrol_new", "Exosomes", "HRT", "spermidine", "semaglutide", "vitaminD", "AKG")

# lifestyle_covariates_survey2<-c("Level.of.Education", "Stress.Level", "Tobacco.Use", "Hours.Sedentary.Remaining.Awake", "Strictly.Followed.Main.Diet", "Red.Meat.times.per.week", "Processed.Food.times.per.week", "Feel.Well.Rested.days.per.week", "Screens.before.bed")

# covariates_to_always_include<-c("Decimal.Chronological.Age", "Biological.Sex" )


# combined_results_df<-model_exposure_wise(path="C:/Users/danwik/OneDrive - Karolinska Institutet/Documents/Project 2 - Vscode/Output/imputed_survey2.RData", outcome_vars=c("DunedinPACE", "GrimAge.PCAgeDev", "OMICmAgeAgeDev"), exposure_vars=c(interventions,lifestyle_covariates_survey2), covariate_vars = covariates_to_always_include)

# plot_forest(combined_results_df[["DunedinPACE"]])
# plot_forest(combined_results_df[["GrimAge.PCAgeDev"]])
# plot_forest(combined_results_df[["OMICmAgeAgeDev"]])

# DunedinPACE<-combined_results_df[["DunedinPACE"]]
# GrimAge.PCAgeDev<-combined_results_df[["GrimAge.PCAgeDev"]]
# OMICmAgeAgeDev<-combined_results_df[["OMICmAgeAgeDev"]]

```



### Model 2 -survey 2
```{r}
# covariates_to_always_include<-c(c("Decimal.Chronological.Age", "Biological.Sex",lifestyle_covariates_survey2 ))

# combined_results_df<-model_exposure_wise(path="C:/Users/danwik/OneDrive - Karolinska Institutet/Documents/Project 2 - Vscode/Output/imputed_survey2.RData", outcome_vars=c("DunedinPACE", "GrimAge.PCAgeDev", "OMICmAgeAgeDev"), exposure_vars=interventions, covariate_vars = covariates_to_always_include)

# plot_forest(combined_results_df[["DunedinPACE"]])
# plot_forest(combined_results_df[["GrimAge.PCAgeDev"]])
# plot_forest(combined_results_df[["OMICmAgeAgeDev"]])

# DunedinPACE<-combined_results_df[["DunedinPACE"]]
# GrimAge.PCAgeDev<-combined_results_df[["GrimAge.PCAgeDev"]]
# OMICmAgeAgeDev<-combined_results_df[["OMICmAgeAgeDev"]]


```

### Model 3 -survey 2
```{r}

# model3_DunedinPACE<-fit_imputed_lm(imp_data_surv2, outcome = "DunedinPACE", exposures=interventions, covariates=covariates_to_always_include)
# plot_forest(model3_DunedinPACE)

# model3_GrimAge.PCAgeDev<-fit_imputed_lm(imp_data_surv2, outcome = "GrimAge.PCAgeDev", exposures=interventions, covariates=covariates_to_always_include)
# plot_forest(model3_GrimAge.PCAgeDev)

# model3_OMICmAgeAgeDev<-fit_imputed_lm(imp_data_surv2, outcome = "OMICmAgeAgeDev", exposures=interventions, covariates=covariates_to_always_include)
# plot_forest(model3_OMICmAgeAgeDev)
```

### model 1 - Survey3
```{r}
# interventions<-c("Rapamycin_new", "Metformin_new", "fasting", "NAD", "TA65", "sulforaphane", "DHEA_new", "SASP_supressors", "Resveratrol_new", "Exosomes", "HRT", "spermidine", "semaglutide", "vitaminD", "AKG")

# lifestyle_covariates_survey3<-c("Level.of.Education", "Stress.Level", "Tobacco.Use", "Hours.of.sleep.per.night", "Hours.Sedentary.Remaining.Awake", "Strictly.Followed.Main.Diet", "Red.Meat.times.per.week", "Processed.Food.times.per.week", "Feel.Well.Rested.days.per.week", "Screens.before.bed",  "BMI")

# covariates_to_always_include<-c("Decimal.Chronological.Age", "Biological.Sex" )

# combined_results_df<-model_exposure_wise(path="C:/Users/danwik/OneDrive - Karolinska Institutet/Documents/Project 2 - Vscode/Output/imputed_survey3.RData", outcome_vars=c("DunedinPACE", "GrimAge.PCAgeDev", "OMICmAgeAgeDev"), exposure_vars=c(interventions,lifestyle_covariates_survey3), covariate_vars = covariates_to_always_include)

# plot_forest(combined_results_df[["DunedinPACE"]])
# plot_forest(combined_results_df[["GrimAge.PCAgeDev"]])
# plot_forest(combined_results_df[["OMICmAgeAgeDev"]])

# DunedinPACE<-combined_results_df[["DunedinPACE"]]
# GrimAge.PCAgeDev<-combined_results_df[["GrimAge.PCAgeDev"]]
# OMICmAgeAgeDev<-combined_results_df[["OMICmAgeAgeDev"]]

```

### Model 2 -survey 3
```{r}

# covariates_to_always_include<-c(c("Decimal.Chronological.Age", "Biological.Sex",lifestyle_covariates_survey3 ))

# combined_results_df<-model_exposure_wise(path="C:/Users/danwik/OneDrive - Karolinska Institutet/Documents/Project 2 - Vscode/Output/imputed_survey3.RData", outcome_vars=c("DunedinPACE", "GrimAge.PCAgeDev", "OMICmAgeAgeDev"), exposure_vars=interventions, covariate_vars = covariates_to_always_include)

# plot_forest(combined_results_df[["DunedinPACE"]])
# plot_forest(combined_results_df[["GrimAge.PCAgeDev"]])
# plot_forest(combined_results_df[["OMICmAgeAgeDev"]])

# DunedinPACE<-combined_results_df[["DunedinPACE"]]
# GrimAge.PCAgeDev<-combined_results_df[["GrimAge.PCAgeDev"]]
# OMICmAgeAgeDev<-combined_results_df[["OMICmAgeAgeDev"]]


```

### Model 3 -survey 3
```{r}

# model3_DunedinPACE<-fit_imputed_lm(imp_data_surv3, outcome = "DunedinPACE", exposures=interventions, covariates=covariates_to_always_include)
# plot_forest(model3_DunedinPACE)

# model3_GrimAge.PCAgeDev<-fit_imputed_lm(imp_data_surv3, outcome = "GrimAge.PCAgeDev", exposures=interventions, covariates=covariates_to_always_include)
# plot_forest(model3_GrimAge.PCAgeDev)

# model3_OMICmAgeAgeDev<-fit_imputed_lm(imp_data_surv3, outcome = "OMICmAgeAgeDev", exposures=interventions, covariates=covariates_to_always_include)
# plot_forest(model3_OMICmAgeAgeDev)
```

